<!DOCTYPE html>
<meta charset="utf-8">
<meta name=viewport content="width=device-width, initial-scale=1">
<title>snapblocks homepage</title>

<meta name=description content="Use snapblocks to write pictures of Snap! scripts in forum posts.">

<link rel=stylesheet href="/style.css">

<!---------------------------------------------------------------------------->

  
<h1>
  <div id=title>
    <a href="/">snapblocks</a>
    <span class=author>v1.0.0 • by <a href="https://github.com/ego-lay-atman-bay">ego-lay-atman-bay</a></span>
  </div>
  <span>
    <a target="_blank" href="https://en.scratch-wiki.info/wiki/Block_Plugin/Syntax">help</a>
    <a href="http://github.com/snap-snapblocks/snapblocks">github</a>
    <!-- <a href="/translator/" id="translate-link"><b>translate</b></a>
    <a href="/generator/"><b>generate</b></a> -->
  </span>
</h1>

<main>
  
  <div id="side">
    <div>
      <select id="choose-style">
        <option value="snap" selected>Snap!</option>
        <option value="scratch2">Scratch 2.0</option>
        <option value="scratch3">Scratch 3.0</option>
        <option value="scratch3-high-contrast">Scratch 3.0 (high-contrast)</option>
      </select>
  
      <select id="choose-lang">
        <option value="">Select language…</option>
      </select>
    </div>
  
    <div id="editor"></div>
  </div>

  <div class="preview-container">
    <a id="export-svg" class="export-link" download="snapblocks.svg">Export SVG</a>
    <a id="export-png" class="export-link" download="snapblocks.png">Export PNG</a>
    
    <pre id="preview" class="blocks"></pre>
    
  </div>
</main>


<!---------------------------------------------------------------------------->

<script src="/js/snapblocks.min.js"></script>
<script src="/js/translations-all.js" charset="utf8"></script>
<script src=/lib/codemirror.build.js></script>

<script>
  var editor = document.getElementById('editor');
  var exportSVGLink = document.getElementById('export-svg');
  var exportPNGLink = document.getElementById('export-png');

  var obj = {
    style: 'snap',
  };
  extractHash();

  var codeEditor = new codemirror.EditorView({
    parent: editor,
    doc: obj.script || "",
    extensions: [
      codemirror.view.keymap.of(codemirror.commands.defaultKeymap),
      codemirror.view.keymap.of(codemirror.commands.indentWithTab),
      codemirror.view.keymap.of([{
        key: "Mod-z",
        run: codemirror.commands.undo,
      },
      {
        key: "Mod-Shift-z",
        run: codemirror.commands.redo,
      },
      {
        key: "Mod-y",
        run: codemirror.commands.redo,
      }]),
      codemirror.language.indentUnit.of('  '),
      codemirror.EditorView.updateListener.of((v) => {
        if (v.docChanged) {
          console.log(v.state)
          console.log(v.state.doc.toString())
          obj.script = v.state.doc.toString();
          objUpdated();
        }
      }),
      codemirror.view.placeholder('. . .'),
      codemirror.commands.history(),
    ],
  });

  var chooseLang = document.getElementById('choose-lang');

  var languageCodes = Object.keys(scratchblocks.allLanguages)
  languageCodes.sort()
  languageCodes.forEach(function (code) {
    if (code === "en") return
    var option = document.createElement("option")
    option.value = code

    var language = scratchblocks.allLanguages[code]
    option.textContent = language.name && language.altName ? language.name + " — " + language.altName : language
      .name || language.altName || code
    chooseLang.appendChild(option)
  })

  var langStatus = document.getElementById('lang-status')

  chooseLang.addEventListener('change', function (e) {
    if (obj.lang === chooseLang.value) return
    obj.lang = chooseLang.value;
    objUpdated();
  });


  var chooseStyle = document.getElementById('choose-style');

  chooseStyle.addEventListener('change', function (e) {
    if (obj.style === chooseStyle.value) return
    obj.style = chooseStyle.value;
    objUpdated();
  });



  /* Extract hash from location. Returns true if changed */
  function extractHash() {
    var newObj = decodeHash();
    if (!newObj || !newObj.script) {
      newObj = {
        script: "",
        lang: obj.lang,
      };
    }

    newObj.style = newObj.style || obj.style || 'scratch3'

    if (newObj.lang !== obj.lang || newObj.script !== obj.script) {
      obj = newObj;
      return true;
    }
    return false;
  }

  function decodeHash() {
    var hash = location.href.split('#')[1];
    if (!hash) return;

    if (!/^\?/.test(hash)) {
      return {
        script: decodeURIComponent(hash),
      };
    } else {
      var newObj = {};
      parts = hash.slice(1).split('&');
      parts.forEach(function (part) {
        var match = /^(.*)=(.*)$/.exec(part);
        if (!match) return;
        var key = decodeURIComponent(match[1]);
        var value = decodeURIComponent(match[2]);
        if (key === "lang" || key === "script" || key === "style") {
          newObj[key] = value;
        }
      });
      return newObj;
    }
  }

  function setHash(hash) {
    if (history && history.replaceState) {
      history.replaceState("", "", hash);
    } else {
      location.hash = hash;
    }
  }

  function objUpdated() {
    // set hash
    if (obj.lang || obj.style) {
      var hash = '#?'
      if (obj.style) hash += 'style=' + encodeURIComponent(obj.style) + '&'
      if (obj.lang) hash += 'lang=' + encodeURIComponent(obj.lang) + '&'
      hash += 'script=' + escape(obj.script)
      setHash(hash)
    } else if (obj.style) {
      setHash('#?lang=' + encodeURIComponent(obj.lang) + '&script=' + encodeURIComponent(obj.script));
    } else if (obj.lang) {
      setHash('#?lang=' + encodeURIComponent(obj.lang) + '&script=' + encodeURIComponent(obj.script));
    } else if (obj.script) {
      setHash('#' + escape(obj.script));
    } else {
      if (!(location.hash == '' || location.hash == '#')) {
        setHash('#');
      }
    }

    // render code
    var doc = window.doc = scratchblocks.parse(obj.script, {
      languages: obj.lang ? ['en', obj.lang] : ['en'],
    });
    var docView = scratchblocks.newView(doc, {
      style: obj.style,
      scale: /^scratch3($|-)/.test(obj.style) ? 0.675 : 1,
    })
    var svg = docView.render()
    svg.classList.add("scratchblocks-style-" + obj.style)
    preview.innerHTML = "";
    preview.appendChild(svg);

    exportSVGLink.href = "";
    exportPNGLink.href = "";

    // add export link
    setTimeout(function () {
      exportSVGLink.href = docView.exportSVG();

      docView.exportPNG(function (pngDataURL) {
        exportPNGLink.href = pngDataURL;
      }, 3);
    }, 0);

    // include code in scratchblocks links
    let translator = document.getElementById('translate-link')
    if (translator) {
      translator.href = "/translator/" + '#' + encodeURIComponent(obj.script);
    }

    // update language dropdown
    var lang = scratchblocks.allLanguages[obj.lang]
    if (langStatus) {
      langStatus.textContent = lang ? lang.percentTranslated + "%" : "";
      if (Object.keys(lang.aliases).length === 0) {
        var link = document.createElement("a")
        link.href = "https://github.com/scratchblocks/scratchblocks/edit/master/locales-src/extra_aliases.js"
        link.textContent = "requires aliases"
        langStatus.textContent += ", "
        langStatus.appendChild(link)
      }
    }
  }

  setInterval(function () {
    if (extractHash()) {
      updatedFromHash();
    }
  }, 200);

  function updatedFromHash() {
    objUpdated();
    chooseLang.value = obj.lang || "";
    chooseStyle.value = obj.style || "";
  }

  updatedFromHash();
</script>
